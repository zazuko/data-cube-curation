# TODO: get rid of base and provide from env variables
@base <http://localhost:5678/> .

@prefix api: <https://rdf-cube-curation.described.at/api/> .
@prefix dataCube: <https://rdf-cube-curation.described.at/> .
@prefix hydra: <http://www.w3.org/ns/hydra/core#> .
@prefix code: <https://code.described.at/> .
@prefix hydra-box: <http://hydra-box.org/schema/> .
@prefix schema: <http://schema.org/> .
@prefix api-project: <https://rdf-cube-curation.described.at/DataCubeModel/> .
@prefix api-source: <https://rdf-cube-curation.described.at/DataCubeSource/> .
@prefix api-column: <https://rdf-cube-curation.described.at/DataCubeSourceColumn/> .

## Entrypoint

<api> a hydra:ApiDocumentation ;
  hydra:entrypoint <> ;
  hydra:supportedClass
    api:Entrypoint ,
    api:Models ,
    dataCube:Model ,
    dataCube:Source ,
    api:Sources ,
    dataCube:Column ,
    api-source:CsvwMetadata .

api:Entrypoint a hydra:Class ;
  hydra:title "The root of the API" ;
  hydra:supportedOperation api:EntrypointGetOperation ;
  hydra:supportedProperty
    [
      hydra:property api:models ;
      hydra:title "Projects" ;
      hydra:readable true ;
      hydra:writeable false
    ].

api:EntrypointGetOperation
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:title "Get the entrypoint resource" ;
  hydra:method "GET" ;
  code:implementedBy [
    a hydra-box:SparqlQuery ;
    hydra-box:source
      <file:hydra/entrypoint/get.sparql>
  ] .

api:models a hydra:Link .

## End Entrypoint

## Models

api:Models a hydra:Class ;
  hydra:title "Data Cube Models" ;
  hydra:supportedOperation
    api:CreateModel ,
    api:GetDataCubeModels .

api:GetDataCubeModels
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get all models" ;
  code:implementedBy [
    a hydra-box:SparqlQuery ;
    hydra-box:source <file:hydra/models/get.rq>, <file:hydra/models/get.manages-block.rq>
  ] .

api:CreateModel
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:title "Design an RDF data cube" ;
  hydra:method "POST" ;
  hydra:returns dataCube:Model ;
  hydra:expects dataCube:Model ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/model#initNew>
      ]
      [
        a hydra-box:SparqlUpdate ;
        hydra-box:source <file:hydra/model/create.ru>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/model/create#setResponse>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/model/get.rq>
      ]
    )
  ] ;
  hydra-box:variables
  [
    hydra:mapping
    [
      a hydra:IriTemplateMapping ;
      hydra:property schema:name ;
      hydra:variable "modelName"
    ]
  ] .

## /End Projects

## Project

dataCube:Model
  a hydra:Class ;
  hydra:title "A data cube mapping model" ;
  hydra:supportedOperation
    api:GetDataCubeModel ;
  hydra:supportedProperty
    [
      hydra:property schema:name ;
      hydra:title "Project name" ;
      hydra:readable true ;
      hydra:writeable true
    ] ,
    [
      hydra:property api-project:sources ;
      hydra:title "Data cube sources" ;
      hydra:writeable false
    ] .

api-project:sources
  a hydra:Link ;
  hydra:supportedOperation api-project:PostSource .

api:GetDataCubeModel
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get a project" ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/model#initExisting>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/model/get.rq>
      ]
    )
  ] .

api-project:PostSource
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "POST" ;
  hydra:title "Create a data cube source" ;
  hydra:returns dataCube:Model ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source#initNew>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source/create#processCsv>
      ]
      [
        a hydra-box:SparqlUpdate ;
        hydra-box:source <file:hydra/project-source/create.ru>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source/create#setResponse>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/project-source/get.rq>, <file:hydra/project-source/get.columns.rq>
      ]
    )
  ] .

api-project:GetSourcesCollection
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get the data cube source" ;
  hydra:returns api:DataCubeSourcesCollection ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/model#initExisting>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/project-source-collection/get.rq>, <file:hydra/project-source-collection/get.manages-block.rq>
      ]
    )
  ] .

## /End Project

## DataCubeSource

api:DataCubeSourcesCollection
  a hydra:Class ;
  hydra:supportedOperation
    api-project:GetSourcesCollection ,
    api-project:PostSource .

api:DataCubeSource
  a hydra:Class ;
  hydra:supportedOperation
    api:GetDataCubeSource ;
  hydra:supportedProperty
    [
      hydra:property schema:name ;
      hydra:title "Source name" ;
      hydra:readable true ;
      hydra:writeable true
    ] ,
    [
      hydra:property api-source:columns ;
      hydra:title "Source columns" ;
      hydra:writeable false
    ] ,
    [
      hydra:property api-source:csvwMetadata ;
      hydra:title "CSVW table mapping" ;
      hydra:writeable false
    ] .

api-source:csvwMetadata a hydra:Link .

api:GetDataCubeSource
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get project source" ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source#initExisting>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/project-source/get.rq>, <file:hydra/project-source/get.columns.rq>
      ]
    )
  ] .

api-source:CsvwMetadata
  a hydra:Class ;
  hydra:supportedOperation
    api-source:GetCsvwMetadata .

api-source:GetCsvwMetadata
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source#initExisting>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/project-source/csvw#projectMappings>
      ]
    )
  ] .

## /End DataCubeSource

## Column

api:DataCubeSourceColumn
  a hydra:Class ;
  hydra:title "Source column" ;
  hydra:supportedProperty
    [
      hydra:property api-column:title ;
      hydra:title "Column heading"
    ] ,
    [
      hydra:property api-column:mapped ;
      hydra:title "Mapped" ;
      hydra:description "Indicates that the column is used in a dimension or measure."
    ].

## /End Column

## Express hooks

<> a api:Entrypoint .
<models> a api:Models .

</model/:modelId> a dataCube:Model .
</model/:modelId/sources> a dataCube:Sources .
</model/:modelId/source/:sourceId> a api:DataCubeSource .
</model/:modelId/source/:sourceId/csvw> a api-source:CsvwMetadata .
