# TODO: get rid of base and provide from env variables
@base <http://localhost:5678/> .

@prefix api: <https://rdf-cube-curation.described.at/> .
@prefix hydra: <http://www.w3.org/ns/hydra/core#> .
@prefix code: <https://code.described.at/> .
@prefix hydra-box: <http://hydra-box.org/schema/> .
@prefix schema: <http://schema.org/> .
@prefix api-project: <https://rdf-cube-curation.described.at/DataCubeProject/> .

## Entrypoint

<api> a hydra:ApiDocumentation ;
  hydra:entrypoint <> ;
  hydra:supportedClass
    api:Entrypoint ,
    api:Installation ,
    api:DataCubeProjects ,
    api:DataCubeProject ,
    api:DataCubeColumn ,
    api-project:CsvwMetadata .

api:Installation a hydra:Class ;
  hydra:title "Data cube curation API setup" ;
  hydra:supportedOperation [
    a hydra-box:View, api:InstallOperation ;
    hydra:method "POST" ;
    hydra:title "Start installation" ;
    code:implementedBy [
      a hydra-box:middlewareChain ;
      code:arguments (
        [
          a hydra-box:SparqlUpdate ;
          hydra-box:source <file:hydra/install.ru>
        ]
        [
          a code:EcmaScript ;
          code:link <file:lib/installation/setResponseHeaders#default>
        ]
      )
    ]
  ].

api:Entrypoint a hydra:Class ;
  hydra:title "The root of the API" ;
  hydra:supportedOperation api:EntrypointGetOperation ;
  hydra:supportedProperty
    [
      hydra:property api:dataCubeProjects ;
      hydra:title "Projects" ;
      hydra:readable true ;
      hydra:writable false
    ].

api:EntrypointGetOperation
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:title "Get the entrypoint resource" ;
  hydra:method "GET" ;
  code:implementedBy [
    a hydra-box:SparqlQuery ;
    hydra-box:source
      <file:hydra/entrypoint/get.sparql> ,
      <file:hydra/entrypoint/installation.get.rq>
  ] .

api:dataCubeProjects a hydra:Link .

## End Entrypoint

## Projects

api:DataCubeProjects a hydra:Class ;
  hydra:title "Data Cube Projects" ;
  hydra:supportedOperation
    api:CreateDataCubeProject ,
    api:GetDataCubeProjects .

api:GetDataCubeProjects
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get all projects" ;
  code:implementedBy [
    a hydra-box:SparqlQuery ;
    hydra-box:source <file:hydra/projects/get.rq>, <file:hydra/projects/get.manages-block.rq>
  ] .

api:CreateDataCubeProject
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:title "Design an RDF data cube" ;
  hydra:method "POST" ;
  hydra:returns api:DataCubeProject ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/project/create#initProject>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/project/create#processCsv>
      ]
      [
        a hydra-box:SparqlUpdate ;
        hydra-box:source <file:hydra/project/create.ru>
      ]
      [
        a code:EcmaScript ;
        code:link <file:lib/project/create#setResponse>
      ]
      [
        a hydra-box:SparqlQuery ;
        hydra-box:source <file:hydra/project/get.rq>, <file:hydra/project/get.columns.rq>
      ]
    )
  ] .

## /End Projects

## Project

api:DataCubeProject
  a hydra:Class ;
  hydra:title "A data cube mapping project" ;
  hydra:supportedOperation
    api:GetDataCubeProject ;
  hydra:supportedProperty
    [
      hydra:property schema:name ;
      hydra:title "Project name" ;
      hydra:readable true ;
      hydra:writable true
    ] ,
    [
      hydra:property api-project:columns ;
      hydra:title "Spreadsheet Columns" ;
      hydra:writable false
    ],
    [
      hydra:property api-project:csvwMetadata ;
      hydra:title "CSVW table mapping" ;
      hydra:writable false
    ] .

api-project:csvwMetadata a hydra:Link .

api:GetDataCubeProject
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  hydra:title "Get a project" ;
  code:implementedBy [
    a hydra-box:SparqlQuery ;
    hydra-box:source <file:hydra/project/get.rq>, <file:hydra/project/get.columns.rq>
  ] .

api-project:CsvwMetadata
  a hydra:Class ;
  hydra:supportedOperation
    api-project:GetCsvwMetadata .

api-project:GetCsvwMetadata
  a hydra:SupportedOperation, hydra-box:View ;
  hydra:method "GET" ;
  code:implementedBy [
    a hydra-box:middlewareChain ;
    code:arguments (
      [
        a code:EcmaScript ;
        code:link <file:lib/project/csvw#projectMappings>
      ]
    )
  ] .

## /End Project

## Column

@prefix api-column: <https://rdf-cube-curation.described.at/DataCubeColumn/> .

api:DataCubeColumn
  a hydra:Class ;
  hydra:title "Source column" ;
  hydra:supportedProperty
    [
      hydra:property api-column:title ;
      hydra:title "Column heading"
    ] ,
    [
      hydra:property api-column:mapped ;
      hydra:title "Mapped" ;
      hydra:description "Indicates that the column is used in a dimension or measure."
    ].

## /End Column

## Express hooks

<> a api:Entrypoint, api:Installation .
<projects> a api:DataCubeProjects .

# TODO: this shows how the route definition will often be split into a template and express route. only template should be necessary
</project/:projectId> a api:DataCubeProject .
</project/:projectId/csvw> a api-project:CsvwMetadata .
[ ]
  a hydra:IriTemplate ;
  hydra:template "/project/{projectId}{/csvw}" ;
  hydra:mapping
  [
    a hydra:IriTemplateMapping ;
    hydra:variable "projectId" ;
    hydra:property <http://schema.org/id>
  ].
